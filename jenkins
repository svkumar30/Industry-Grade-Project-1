pipeline {
    agent any

    environment {
        DOCKER_IMAGE = "abcapp:v1"
        DOCKER_REGISTRY = "vijay1453/abcapp:v1"
	WORK_DIR = "/var/lib/jenkins/workspace/CI-CD-IGP"
    }

    stages {
        stage('Clean Workspace') {
            steps {
                echo "Cleaning workspace..."
                sh '''
                   rm -rf /home/ubuntu/warfile
                   mkdir -p /home/ubuntu/warfile
                '''
            }
        }

        stage('Copy WAR File') {
            steps {
                echo "Copying WAR file from Jenkins workspace to /home/ubuntu/warfile..."
                sh '''
                   cp ${WORK_DIR}/target/ABCtechnologies-1.0-1.0.war /home/ubuntu/warfile/
                '''
            }
        }

        stage('Build Docker Image') {
            steps {
                echo "Building Docker image..."
                dir('/home/ubuntu/warfile') {
                    sh '''
                       docker build -t ${DOCKER_IMAGE} .
                    '''
                }
            }
        }

        stage('Tag Docker Image') {
            steps {
                echo "Tagging Docker image..."
                sh '''
                   docker tag ${DOCKER_IMAGE} ${DOCKER_REGISTRY}
                '''
            }
        }

        stage('Push Docker Image') {
            steps {
                echo "Pushing Docker image to Docker Hub..."
                sh '''
                   docker push ${DOCKER_REGISTRY}
                '''
            }
        }
    }

    post {
        always {
            echo 'Cleaning up workspace...'
            cleanWs()  // Clean workspace after build
        }
        success {
            echo 'Build completed successfully!'
        }
        failure {
            echo 'Build failed!'
        }
    }
}